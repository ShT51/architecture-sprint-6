## Проектирование продажи ОСАГО

## Упрощенная схема взаимодействия компонентов
### 1. Взаимодействие `веб-приложения` с `core-app`
- (Client pull) для запроса на создание заявки с передачей параметров авто и клиента используется обычный REST. В качестве ответа получаем
id запроса
- (Server push) для запроса на получение результатов от страховых компаний можно использовать REST c Long Polling, но лучше использовать
**WebSocket** или просто **SSE** так, как тут нужна будет только односторонняя связь

### 2. Взаимодействие `core-app` с `osago-aggregator`
- REST ("точка-точка") для создания заявки. `core-app` делает запрос на создание заявки и передает ее параметры.
id заявки можно генерировать и тут, пробрасывать его обратно в `core-app` и `веб-приложения` тем самым, гарантировать, что заявка создана 
- **Apache Kafka** ("публикация-подписка") `core-app` подписывается на топик кафка куда `osago-aggregator` будет публиковать
полученные предложения от страховых компаний. По мере поступления предложений, `core-app` будет их сохранять в БД, чтобы отобразить на фронт
при запросе на получение ответов на заявку по ее id.

### 3. Взаимодействие `osago-aggregator` со страховыми компаниями
- выполняет N синхронных параллельных запросов на создание заявки во все страховые компании (*ручка `создать заявку на ОСАГО`*)
- в фоновом режиме, периодически в параллельных синхронных запросах (с таймаутом в 60 сек) опрашивает страховые компании (*ручка `получить предложение по заявке`*), 
и если в одном из потоков появляется ответ от страховой компании, сервис отправляет его в соответствующий топик Кафка.
- может иметь свою отдельную БД для реализации паттерна **Transactional Outbox**

## Паттерны отказоустойчивости
1. **Rate Limit** между `core-app` и `osago-aggregator` для защиты от "DDOS" от партнеров  
\+ **Circuit Breaker** при ошибках на стороне интеграций со страховыми компаниями
2. **Timeout** + **Retry** + **Circuit Breaker** между `osago-aggregator` и REST API страховых компаний
3. **Rate Limit** на уровне инфраструктуры перед `веб-приложением`
