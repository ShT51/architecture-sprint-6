## Проектирование продажи ОСАГО

## Упрощенная схема взаимодействия компонентов
### 1. Взаимодействие `веб-приложения` с `core-app`
- в качестве протокола взаимодействия между `веб-приложением` и `core-app` предлагаю использовать **WebSocket** так как
бизнес хочет, чтобы клиенты в реальном времени получали предложения от страховых компаний.
- `веб-приложением` устанавливает соединение с `core-app`, передавая ему параметры авто

### 2. Взаимодействие `core-app` с `osago-aggregator`
- предлагаю использовать **Apache ActiveMQ Artemis** для потоковой доставки сообщений с предложениями от страховых компаний, 
что значительно упростит маршрутизацию запросов (по сравнению с **Кафка**), но при этом обеспечит необходимую производительность
- `core-app` устанавливает соединение с `osago-aggregator` через очереди, отправляет запрос на оформление ОСАГО в очередь запросов (`rq.queue`),
и слушает очередь ответов (`rs.queue`) в асинхронном режиме, при получении ответа от `osago-aggregator` сразу же отправляет его через websocket в `веб-приложение`

### 3. Взаимодействие `osago-aggregator` со страховыми компаниями
- при получении сообщения от `core-app` из `rq.queue`, сервис сохраняет его в локальную БД (для возможного кеширования, аудита и т.д.)
- выполняет N синхронных параллельных запросов на создание заявки во все страховые компании (*ручка `создать заявку на ОСАГО`*)
- в фоном режиме периодически в параллельных запросах опрашивает страховые компании (*ручка `получить предложение по заявке`*), 
и если в одном из потоков появляется ответ от страховой компании, сервис отправляет его в `rs.queue`.
- когда все страховые компании предоставили свои предложения (или вышел таймаут в 60 сек) отправляется "терминальное" сообщение в очередь ответов

## Паттерны отказоустойчивости
1. **Rate Limit** между `core-app` и `osago-aggregator` для защиты от "DDOS" от партнеров  
\+ **Circuit Breaker** при ошибках на стороне интеграций со страховыми компаниями
2. **Timeout** + **Retry** + **Circuit Breaker** между `osago-aggregator` и REST API страховых компаний
3. **Rate Limit** на уровне инфраструктуры перед `веб-приложением`
